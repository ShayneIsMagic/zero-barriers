---
const { title, description } = Astro.props;
const gtmId = import.meta.env.PUBLIC_GTM_ID || "";
const gtmScript = `
        (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", "${gtmId}");`;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Performance optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/styles/main.css" as="style" />
    <link rel="preload" href="/js/main.js" as="script" />
    
    <title>{title}</title>
    
    <!-- Google Fonts with display=swap for better performance -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    
    <!-- Local Font Awesome Icons -->
    <link rel="stylesheet" href="/styles/fontawesome-local.css" />
    
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="icon" href="/zblogo.png" type="image/png" />

    <!-- Google Tag Manager -->
    {gtmId && <script set:html={gtmScript} />}
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`}
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe></noscript
    >
    <!-- End Google Tag Manager (noscript) -->

    <slot />
  </body>

  <script src="/js/main.js" defer></script>
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Inline service worker for caching
        const swContent = `
          const CACHE_NAME = 'zero-barriers-v1';
          const urlsToCache = [
            '/',
            '/styles/main.css',
            '/js/main.js',
            '/images/Team.png',
            '/images/Human_Transformation.png',
            '/zblogo.png'
          ];

          self.addEventListener('install', event => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then(cache => cache.addAll(urlsToCache))
            );
          });

          self.addEventListener('fetch', event => {
            event.respondWith(
              caches.match(event.request)
                .then(response => response || fetch(event.request))
            );
          });
        `;

        const blob = new Blob([swContent], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  </script>
</html>
